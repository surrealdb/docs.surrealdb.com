---
import { svgFromAst, type RailroadNode } from "../util/railroad";
// Props: either provide a JSON AST via `ast`, or raw `svg`.
// Optional: `padding` to override default paddings on the diagram root.
interface Props {
  ast?: RailroadNode;
  svg?: string;
  padding?: number | [number] | [number, number] | [number, number, number, number];
  className?: string;
}

const { ast, svg, padding, className } = Astro.props as Props;

let svgMarkup: string | undefined = svg;
if (!svgMarkup && ast) {
  svgMarkup = svgFromAst(ast, padding);
}

// Make SVG responsive to the page/container width
if (svgMarkup) {
  svgMarkup = svgMarkup
    // remove fixed width/height to allow CSS sizing
    .replace(/\swidth=\"[^\"]+\"/i, "")
    .replace(/\sheight=\"[^\"]+\"/i, "")
    // add responsive sizing and preserve aspect ratio
    .replace(
      /<svg(\s)/i,
      '<svg style="width:100%;height:auto;background:rgba(var(--color-code),1);background-color:rgba(var(--color-code),1);" preserveAspectRatio="xMidYMin meet" '
    );
}

// Ensure the package CSS is available on the page.
// Consumers can also include this globally if preferred.
---
<link rel="stylesheet" href="/node_modules/railroad-diagrams/railroad-diagrams.css" />

<div class={className} style="overflow-x:auto;">
  <div set:html={svgMarkup} />
  <style>
    .railroad-diagram { width: 100%; height: auto; }
    /* Theme alignment for SurrealDB (light/dark via CSS variables) */
    :root svg.railroad-diagram { 
      background: linear-gradient(90deg, rgba(var(--color-code),1) 0%, rgba(var(--color-background-secondary),0.7) 100%) !important; 
      background-color: rgba(var(--color-code),1) !important; 
      box-shadow: 0 2px 8px 0 rgba(0,0,0,0.08), 0 0 0 2px rgba(var(--color-surreal-pink),0.15);
      border-radius: 6px;
    }
    :root svg.railroad-diagram path { stroke: rgba(var(--color-text), 0.85) !important; fill: transparent !important; }
    @media (prefers-color-scheme: dark) {
      :root svg.railroad-diagram path { stroke: rgba(255, 255, 255, 1) !important; }
    }
    :root svg.railroad-diagram text { fill: rgba(var(--color-text), 1) !important; font: 13px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace !important; }
    :root svg.railroad-diagram text.comment { fill: rgba(var(--color-faint), 1) !important; font-style: italic !important; font-size: 12px !important; }
    /* Default all boxes (terminals and non-terminals) */
    :root svg.railroad-diagram rect { fill: rgba(var(--color-background-secondary), 1) !important; stroke: rgba(var(--color-border), 1) !important; }
    /* Terminals have rounded corners in this library -> rect[rx] */
    :root svg.railroad-diagram rect[rx] { fill: rgba(var(--color-surreal-pink), 0.15) !important; stroke: rgba(var(--color-surreal-pink), 0.7) !important; }
  </style>
</div>


