---
import type { CollectionKey } from 'astro:content';
import SdkJsVersionSwitcher from '@src/components/shared/SdkJsVersionSwitcher.astro';
import SdkPyVersionSwitcher from '@src/components/shared/SdkPyVersionSwitcher.astro';
import SurrealQLVersionSwitcher from '@src/components/shared/SurrealQLVersionSwitcher.astro';
import { isSurrealQLPath } from '@src/util/surrealqlVersion';
import { Icon } from 'astro-icon/components';
import SidebarItem, {
    type SidebarItem as TSidebarItem,
} from './SidebarItem.astro';
import { metadata } from './metadata';

type Props = {
    items: TSidebarItem[];
    collection: Exclude<CollectionKey, 'labs-items'>;
};

const { items, collection } = Astro.props;
const doc = metadata[collection];
const isSurrealQL = collection === 'doc-surrealql';
const isSdkJs =
    collection === 'doc-sdk-javascript' ||
    collection === 'doc-sdk-javascript-1x';
const isSdkPy =
    collection === 'doc-sdk-python' ||
    collection === 'doc-sdk-python-1x';
---

<div class="flex flex-col h-full">
	<div class="flex items-center justify-between border-b border-border px-6 py-4 lg:hidden">
		<span class="text-xs uppercase tracking-[0.25em] text-text/60">Table of Contents</span>
		<label
			for="sidebar-toggle"
			class="rounded-lg p-2 text-text/70 transition-colors hover:bg-bwr/10"
		>
			<Icon name="fa6-solid:xmark" class="h-4 w-4" />
		</label>
	</div>
    <div
		id="sidebar-container"
		class="overflow-y-auto flex-grow pb-8 lg:pt-4"
		data-collection={collection}
	>
        {isSurrealQL && (
            <div class="px-4 lg:px-6 pt-6 pb-4 border-b border-border">
                <SurrealQLVersionSwitcher currentPath={Astro.url.pathname} />
            </div>
        )}
        {isSdkJs && (
            <div class="px-4 lg:px-6 pt-6 pb-4 border-b border-border">
                <SdkJsVersionSwitcher />
            </div>
        )}
        {isSdkPy && (
            <div class="px-4 lg:px-6 pt-6 pb-4 border-b border-border">
                <SdkPyVersionSwitcher />
            </div>
        )}
        <div class="px-4 lg:px-6 py-6">
            {items.map((item) => (
                <SidebarItem {...item} />
            ))}
        </div>
        {doc?.repo && (
            <div class="mx-6 lg:mx-8 px-2 py-3 border-t border-border">
                <a href={doc.repo.href} class="text-sm flex items-center gap-1.5 text-opacity-50">
                    {doc.repo.title}
                    <Icon name="fa6-solid:arrow-up-right-from-square" class="w-2.5" />
                </a>
            </div>
        )}
    </div>
</div>

<script>

	// Stores the scroll position in session storage when a sidebar link is clicked.
	// This is needed to restore the scroll position when the user navigates to a page.
	// We can't use hash-based scrolling because the sidebar is a separate component,
	// And if we do implement the content is scrolled down.

	const container = document.querySelector<HTMLDivElement>("#sidebar-container");

	if (!container) {
		throw new Error("Sidebar container not found");
	}

	const storedOffset = sessionStorage.getItem('surrealdb:sidebar-offset');
	const previousDoc = sessionStorage.getItem('surrealdb:previous-doc');
	const currentDoc = container.dataset.collection ?? "";

	// Check if we should restore scroll position
	const shouldRestoreScroll = storedOffset && previousDoc === currentDoc;

	if (shouldRestoreScroll) {
		// Restore the saved scroll position
		container.scrollTop = parseInt(storedOffset, 10);
	} else {
		// Clear old storage if we're on a different doc
		if (previousDoc && previousDoc !== currentDoc) {
			sessionStorage.removeItem('surrealdb:sidebar-offset');
			sessionStorage.removeItem('surrealdb:previous-doc');
		}
		
		// Only scroll to active element if we didn't restore a saved position
		// This prevents overriding the user's saved scroll position
		const active = container.querySelector<HTMLDivElement>('.text-surreal-energy');
		if (active && !shouldRestoreScroll) {
			const offsetTop = active.offsetTop - (container.clientHeight / 2) + (active.clientHeight / 2);
			container.scrollTo({ 
				top: offsetTop,
				behavior: 'smooth',
			});
		}
	}

	container.addEventListener('click', (e) => {
		const target = e.target as HTMLElement;

		// Only save scroll position for sidebar links, not version switcher
		if (target.matches('.sidebar-link') && !target.closest('#version-switcher-container') && !target.closest('#sdk-js-version-switcher-container') && !target.closest('#sdk-py-version-switcher-container')) {
			sessionStorage.setItem('surrealdb:sidebar-offset', container.scrollTop.toString());
			sessionStorage.setItem('surrealdb:previous-doc', currentDoc);
		}
	});
</script>
