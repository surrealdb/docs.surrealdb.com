---
import type { CollectionEntry } from 'astro:content';
import { getEntry } from 'astro:content';
import type { CollectionKey } from 'astro:content';
import ThumbnailDocs from '@assets/img/social-preview.jpg';
import Dropdown from '@components/Dropdown/Dropdown.astro';
import DropdownItem from '@components/Dropdown/DropdownItem.astro';
import { PageHeadings } from '@components/PageHeadings.tsx';
import Sidebar from '@components/Sidebar/index.astro';
import {
    findNextPage,
    findPreviousPage,
    generateBreadcrumb,
    generateSidebar,
} from '@src/util/doc';
import { isSdkJsPath } from '@src/util/sdkJsVersion';
import { isSurrealQLPath } from '@src/util/surrealqlVersion';
import { cn } from '@src/util/tailwind';
import { Icon } from 'astro-icon/components';
import { metadata } from './Sidebar/metadata';
import BaseLayout from './layout/BaseLayout.astro';
import Footer from './layout/Footer/Footer.astro';
import MarkdownContainer from './shared/MarkdownContainer.astro';
import SdkJsVersionBanner from './shared/SdkJsVersionBanner.astro';
import SurrealQLVersionBanner from './shared/SurrealQLVersionBanner.astro';

type DocName = Exclude<CollectionKey, 'labs-items'> extends `doc-${infer T}`
    ? T
    : never;

interface Props {
    doc: DocName;
    slug: CollectionEntry<`doc-${DocName}`>['slug'];
    noPageHeadings?: boolean;
    noSidebar?: boolean;
    containerWidth?: number;
}

const { doc, noPageHeadings, noSidebar } = Astro.props;
const collection = `doc-${doc}` satisfies CollectionKey;

const slug = Astro.props.slug.endsWith('/')
    ? Astro.props.slug.slice(0, -1)
    : Astro.props.slug;
const entry = await getEntry(collection, slug);

if (!entry) {
    throw new Error(`Entry not found: doc=${doc}, slug=${slug}`);
}

const [{ Content, headings }, sidebarItems, breadcrumb] = await Promise.all([
    entry.render(),
    generateSidebar(collection),
    generateBreadcrumb(collection, slug),
]);

const sidebarIndex = sidebarItems.flat.findIndex((item) => item.slug === slug);
const prev = findPreviousPage(sidebarItems.flat, sidebarIndex);
const next =
    findNextPage(sidebarItems.flat, sidebarIndex) ?? sidebarItems.flat[0];

function filteredHeadings() {
    if (
        headings[0]?.text ===
            (entry as CollectionEntry<CollectionKey>).data.title ||
        headings[0]?.text ===
            (entry as CollectionEntry<Exclude<CollectionKey, 'labs-items'>>)
                .data.sidebar_label
    ) {
        return headings.slice(1);
    }

    return headings;
}

const meta = metadata[collection];
const thumbnail = 'thumbnail' in meta ? meta.thumbnail.src : ThumbnailDocs.src;

// Construct URLs for AI chat services
const currentPageUrl = Astro.url.href;
const encodedUrl = encodeURIComponent(currentPageUrl);
const chatGptUrl = `https://chat.openai.com/?q=Read%20from%20${encodedUrl}%20so%20I%20can%20ask%20questions%20about%20it.`;
const claudeUrl = `https://claude.ai/new?q=Read%20from%20${encodedUrl}%20so%20I%20can%20ask%20questions%20about%20it.`;
---

<style>
	/* Prevent page-level horizontal scroll */
	:global(html), :global(body) {
		overflow-x: hidden;
		max-width: 100vw;
	}

	:global(#sidebar-toggle:checked) ~ div :global(.toc-overlay) {
		@apply opacity-100 pointer-events-auto;
	}

	:global(#sidebar-toggle:checked) ~ div :global(.toc-drawer) {
		@apply max-lg:translate-x-0;
	}

	:global(#sidebar-toggle:not(:checked)) ~ div :global(.toc-drawer) {
		@apply max-lg:-translate-x-full;
	}

	/* Table of contents scrollbar styling */
	.toc-container > div {
		scrollbar-width: thin;
		scrollbar-color: rgb(var(--color-border)) transparent;
	}
	
	.toc-container > div::-webkit-scrollbar {
		width: 6px;
	}
	
	.toc-container > div::-webkit-scrollbar-track {
		background: transparent;
	}
	
	.toc-container > div::-webkit-scrollbar-thumb {
		background-color: rgb(var(--color-border));
		border-radius: 3px;
	}
	
	.toc-container > div::-webkit-scrollbar-thumb:hover {
		background-color: rgb(var(--color-text) / 0.3);
	}

	/* Position buttons container next to the first H1 */
	.content-with-actions {
		position: relative;
		max-width: 100%;
	}

	.content-with-actions :global(> markdown-container > h1:first-child) {
		padding-right: 240px;
		word-wrap: break-word;
		overflow-wrap: break-word;
		hyphens: auto;
	}

	@media (max-width: 1024px) {
		.content-with-actions :global(> markdown-container > h1:first-child) {
			padding-right: 200px;
		}
	}

	@media (max-width: 640px) {
		.content-with-actions :global(> markdown-container > h1:first-child) {
			padding-right: 0;
		}
	}

	.page-header-actions {
		position: absolute;
		top: 0;
		right: 0;
		z-index: 10;
	}

	@media (max-width: 640px) {
		.page-header-actions {
			position: static;
			margin-top: 0.75rem;
			margin-bottom: 1.5rem;
			max-width: 100%;
			flex-wrap: wrap;
		}
	}

	/* Responsive dropdown alignment */
	:global(.page-actions-dropdown) {
		position: static;
	}

	:global(.page-actions-dropdown drop-down) {
		position: relative;
	}

	/* Mobile: dropdown fixed to viewport */
	@media (max-width: 639px) {
		:global(.page-actions-dropdown drop-down .dropdown-dropdown) {
			position: fixed !important;
			left: 1rem !important;
			right: 1rem !important;
			width: auto !important;
			max-width: none !important;
			transform-origin: top center;
		}

		:global(.page-actions-dropdown drop-down .dropdown-dropdown > div) {
			width: 100%;
			min-width: 0 !important;
		}
	}

	/* Desktop: dropdown positions normally */
	@media (min-width: 640px) {
		:global(.page-actions-dropdown) {
			position: relative;
		}

		:global(.page-actions-dropdown drop-down .dropdown-dropdown) {
			right: 0 !important;
			left: auto !important;
			transform-origin: top right;
			min-width: 260px;
			max-width: 320px;
		}
	}

	/* Prevent horizontal overflow */
	.content-with-actions {
		overflow-x: hidden;
	}

	/* Global overflow prevention for mobile */
	:global(markdown-container) {
		max-width: 100%;
		overflow-x: auto;
		overflow-wrap: break-word;
		word-wrap: break-word;
	}

	:global(markdown-container pre) {
		max-width: 100%;
		overflow-x: auto;
	}

	:global(markdown-container table) {
		display: block;
		max-width: 100%;
		overflow-x: auto;
	}

	:global(markdown-container img) {
		max-width: 100%;
		height: auto;
	}
</style>

<BaseLayout
	title={entry.data.title}
	description={entry.data.description}
	image={thumbnail}
>
	<div class="flex-1 flex min-h-0">
		<!-- Sidebar -->
		{
			!noSidebar && (
				<>
					<div class="toc-overlay fixed inset-0 z-30 bg-background/70 backdrop-blur-md opacity-0 transition-opacity pointer-events-none lg:hidden">
						<label
							for="sidebar-toggle"
							class="absolute inset-0 cursor-pointer"
							aria-label="Close table of contents"
						></label>
					</div>
					<div
						class:list={[
							"toc-drawer w-full lg:w-[350px] max-w-sm lg:max-w-none flex-shrink-0 border-r border-border bg-background-secondary lg:bg-background flag-sidebar-container z-40",
							"max-lg:fixed inset-y-0 max-lg:left-0 max-lg:transition-transform max-lg:duration-300",
						]}
					>
						<Sidebar
							items={sidebarItems.items}
							collection={collection}
						/>
					</div>
				</>
			)
		}

		<!-- Document -->
		<div class="flex-1 overflow-y-scroll overflow-x-hidden">
			<div class="flex flex-row min-w-0">
				<!-- Article -->
				<div class="flex-1 min-w-0">
					<div
						class={cn(
							"w-full mx-auto py-6 px-4 sm:px-8 space-y-8 box-border overflow-x-hidden",
							!noSidebar ? "max-w-[960px]" : "max-w-[1300px]",
						)}
					>
						<div
							class="flex items-center gap-3 pb-4 overflow-x-auto"
						>
							<label
								for="sidebar-toggle"
								class="lg:hidden rounded-lg p-2 text-text/70 transition-colors hover:bg-bwr/10 cursor-pointer sidebar-toggle"
							>
								<Icon name="fa6-solid:folder-tree" class="w-4 h-4" />
							</label>
							<div class="lg:hidden h-6 border-border border-r" />
							<a
								href={`${import.meta.env.BASE_URL}/${doc.startsWith("sdk-") ? `sdk/${doc.slice(4)}` : doc}`}
								class="text-text/60"
							>
								<Icon name="fa6-solid:house" class="w-3.5" />
							</a>
							{
								breadcrumb.items.map(({ title, href }) => (
									<>
										<Icon
											name="fa6-solid:chevron-right"
											class="w-1.5 min-w-1.5 text-text/40"
										/>
										{href === undefined ? (
											<p class="text-text/60 font-extralight whitespace-nowrap cursor-not-allowed">
												{title}
											</p>
										) : (
											<a
												href={href}
												class="text-text/60 font-extralight whitespace-nowrap"
											>
												{title}
											</a>
										)}
									</>
								))
							}
						</div>
						
						{isSurrealQLPath(Astro.url.pathname) && (
							<SurrealQLVersionBanner
								currentPath={Astro.url.pathname}
								contentPath={`${collection}/${entry.id}`}
							/>
						)}
						{isSdkJsPath(Astro.url.pathname) && (
							<SdkJsVersionBanner
								currentPath={Astro.url.pathname}
							/>
						)}
						
						<!-- Content with action buttons positioned next to H1 -->
						<div class="content-with-actions">
							<div class="page-header-actions flex items-center gap-2">
								<a
									href={`https://github.com/surrealdb/docs.surrealdb.com/edit/main/src/content/${collection}/${entry.id}`}
									class="flex items-center gap-2 px-2 sm:px-3 py-1.5 rounded-lg border border-border hover:border-surreal-energy hover:text-surreal-energy transition-colors text-sm"
								>
									<Icon name="fa6-solid:pencil" class="w-3.5 h-3.5" />
									<span class="hidden sm:inline">Edit page</span>
								</a>
								<div class="page-actions-dropdown">
									<Dropdown align="right" >
										<div
											class="flex items-center gap-1 sm:gap-2 px-2 sm:px-3 py-1.5 rounded-lg border border-border hover:border-surreal-energy transition-colors text-sm cursor-pointer select-none"
										>
											<Icon name="fa6-solid:copy" class="w-3.5 h-3.5" />
											<span class="hidden sm:inline">Copy page</span>
											<Icon name="fa6-solid:chevron-down" class="w-2.5 flex-shrink-0" />
										</div>
										<div slot="dropdown" class="flex flex-col gap-1 w-full">
											<DropdownItem
												title="Copy as Markdown"
												description="Copy page content for LLMs"
												iconName="fa6-regular:copy"
												dataUrl={`https://raw.githubusercontent.com/surrealdb/docs.surrealdb.com/main/src/content/${collection}/${entry.id}`}
											/>
											<DropdownItem
												title="Open in ChatGPT"
												description="Ask questions about this page"
												href={chatGptUrl}
												external={true}
											>
												<svg slot="icon" viewBox="0 0 24 24" fill="currentColor">
													<path d="M22.282 9.821a5.985 5.985 0 0 0-.516-4.91 6.046 6.046 0 0 0-6.51-2.9A6.065 6.065 0 0 0 4.981 4.18a5.985 5.985 0 0 0-3.998 2.9 6.046 6.046 0 0 0 .743 7.097 5.98 5.98 0 0 0 .51 4.911 6.051 6.051 0 0 0 6.515 2.9A5.985 5.985 0 0 0 13.26 24a6.056 6.056 0 0 0 5.772-4.206 5.99 5.99 0 0 0 3.997-2.9 6.056 6.056 0 0 0-.747-7.073zM13.26 22.43a4.476 4.476 0 0 1-2.876-1.04l.141-.081 4.779-2.758a.795.795 0 0 0 .392-.681v-6.737l2.02 1.168a.071.071 0 0 1 .038.052v5.583a4.504 4.504 0 0 1-4.494 4.494zM3.6 18.304a4.47 4.47 0 0 1-.535-3.014l.142.085 4.783 2.759a.771.771 0 0 0 .78 0l5.843-3.369v2.332a.08.08 0 0 1-.033.062L9.74 19.95a4.5 4.5 0 0 1-6.14-1.646zM2.34 7.896a4.485 4.485 0 0 1 2.366-1.973V11.6a.766.766 0 0 0 .388.676l5.815 3.355-2.02 1.168a.076.076 0 0 1-.071 0l-4.83-2.786A4.504 4.504 0 0 1 2.34 7.872zm16.597 3.855l-5.833-3.387L15.119 7.2a.076.076 0 0 1 .071 0l4.83 2.791a4.494 4.494 0 0 1-.676 8.105v-5.678a.79.79 0 0 0-.407-.667zm2.01-3.023l-.141-.085-4.774-2.782a.776.776 0 0 0-.785 0L9.409 9.23V6.897a.066.066 0 0 1 .028-.061l4.83-2.787a4.5 4.5 0 0 1 6.68 4.66zm-12.64 4.135l-2.02-1.164a.08.08 0 0 1-.038-.057V6.075a4.5 4.5 0 0 1 7.375-3.453l-.142.08-4.778 2.758a.795.795 0 0 0-.393.681zm1.097-2.365l2.602-1.5 2.607 1.5v2.999l-2.597 1.5-2.607-1.5z"/>
												</svg>
											</DropdownItem>
											<DropdownItem
												title="Open in Claude"
												description="Ask questions about this page"
												href={claudeUrl}
												external={true}
											>
												<svg slot="icon" viewBox="0 0 24 24" fill="currentColor">
													<path d="M12 1.5a1.25 1.25 0 0 1 1.25 1.25v6.5a1.25 1.25 0 0 1-2.5 0v-6.5A1.25 1.25 0 0 1 12 1.5zm0 13.25a1.25 1.25 0 0 1 1.25 1.25v5.25a1.25 1.25 0 0 1-2.5 0V16a1.25 1.25 0 0 1 1.25-1.25zM22.5 12a1.25 1.25 0 0 1-1.25 1.25H16a1.25 1.25 0 0 1 0-2.5h5.25A1.25 1.25 0 0 1 22.5 12zM9.25 12A1.25 1.25 0 0 1 8 13.25H2.75a1.25 1.25 0 0 1 0-2.5H8A1.25 1.25 0 0 1 9.25 12zm10.29-7.54a1.25 1.25 0 0 1 0 1.77l-3.72 3.71a1.25 1.25 0 0 1-1.77-1.77l3.72-3.71a1.25 1.25 0 0 1 1.77 0zM9.95 14.05a1.25 1.25 0 0 1 0 1.77l-3.71 3.72a1.25 1.25 0 1 1-1.78-1.77l3.72-3.72a1.25 1.25 0 0 1 1.77 0zm9.59 5.49a1.25 1.25 0 0 1-1.77 0l-3.72-3.72a1.25 1.25 0 0 1 1.77-1.77l3.72 3.72a1.25 1.25 0 0 1 0 1.77zM9.95 9.95a1.25 1.25 0 0 1-1.77 0L4.46 6.23a1.25 1.25 0 0 1 1.78-1.77l3.71 3.72a1.25 1.25 0 0 1 0 1.77z"/>
												</svg>
											</DropdownItem>
										</div>
									</Dropdown>
								</div>
							</div>
							<MarkdownContainer
								class="flag-page-headings-content flag-page-content"
							>
								<Content />
							</MarkdownContainer>
						</div>
						<div>
							<div class="flex justify-between gap-8">
								{
									prev && (
										<a
											href={prev.href}
											class="text-faint hover:border-surreal-energy flex items-center gap-2.5 border border-border rounded-lg py-3 px-6 w-1/2 min-h-20"
										>
											<Icon
												name="fa6-solid:chevron-left"
												class="w-3"
											/>
											<span>{prev.title}</span>
										</a>
									)
								}
								{
									next && (
										<a
											href={next.href}
											class="text-faint hover:border-surreal-energy flex items-center gap-2.5 border border-border rounded-lg py-3 px-6 w-1/2 min-h-20 justify-end"
										>
											<span>{next.title}</span>
											<Icon
												name="fa6-solid:chevron-right"
												class="w-3"
											/>
										</a>
									)
								}
							</div>
						</div>
					</div>
				</div>

				<!-- Table of contents -->
				<div
					class="pt-6 w-[350px] hidden 2xl:block flex-shrink-0"
				>
					<div
						class="sticky top-4 h-[calc(100svh-8.5rem)] px-3 border-l border-border py-2 flex flex-col toc-container"
					>
						<div class="flex flex-col gap-3 overflow-y-auto min-h-0 flex-1">
						{
							!noPageHeadings &&
								filteredHeadings().length > 0 && (
									<>
										<h3 class="uppercase font-mono text-xs font-semibold">
											On this page
										</h3>
										<PageHeadings
											headings={filteredHeadings()}
											client:load
										/>
									</>
								)
						}
						<div class="pt-3 border-t border-border">
							<span
								class="text-text/60 text-xs flex items-center gap-1.5"
							>
								<Icon name="fa6-solid:clock" class="w-3" />
								Last updated: <span
									class="last-edited-date"
									data-file-path={`src/content/${collection}/${entry.id}`}
									>Loading...</span
								>
							</span>
						</div>

						<!-- Page Feedback -->
						<div class="pt-3 border-t border-border">
							<div class="flex flex-col gap-3">
								<h3
									class="uppercase font-mono text-xs font-semibold"
								>
									Was this page helpful?
								</h3>
								<div class="flex gap-2">
									<button
										class="feedback-btn feedback-positive p-2 rounded-lg border border-border hover:border-surreal-energy transition-colors"
										data-feedback="positive"
									>
										<Icon
											name="fa6-solid:thumbs-up"
											class="w-4 h-4"
										/>
									</button>
									<button
										class="feedback-btn feedback-negative p-2 rounded-lg border border-border hover:border-surreal-energy transition-colors"
										data-feedback="negative"
									>
										<Icon
											name="fa6-solid:thumbs-down"
											class="w-4 h-4"
										/>
									</button>
								</div>

								<!-- Feedback Forms -->
								<div class="feedback-forms hidden">
									<!-- Positive Feedback Form -->
									<div
										class="feedback-form positive-feedback hidden"
									>
										<h4 class="text-sm font-semibold mb-3">
											What did you like?
										</h4>
										<div class="flex flex-col gap-2 mb-3">
											<label
												class="flex items-center gap-2 text-xs"
											>
												<input
													type="radio"
													name="positive-feedback"
													value="accurate"
													class="w-3 h-3"
												/>
												<span>Accurate</span>
											</label>
											<label
												class="flex items-center gap-2 text-xs"
											>
												<input
													type="radio"
													name="positive-feedback"
													value="easy-to-understand"
													class="w-3 h-3"
												/>
												<span>Easy to understand</span>
											</label>
											<label
												class="flex items-center gap-2 text-xs"
											>
												<input
													type="radio"
													name="positive-feedback"
													value="solved-problem"
													class="w-3 h-3"
												/>
												<span>Solved my problem</span>
											</label>
											<label
												class="flex items-center gap-2 text-xs"
											>
												<input
													type="radio"
													name="positive-feedback"
													value="helped-decide"
													class="w-3 h-3"
												/>
												<span
													>Helped me decide to use the
													product</span
												>
											</label>
											<label
												class="flex items-center gap-2 text-xs"
											>
												<input
													type="radio"
													name="positive-feedback"
													value="other"
													class="w-3 h-3"
												/>
												<span>Other</span>
											</label>
										</div>
										<textarea
											placeholder="Tell us more about your experience"
											class="w-full p-2 text-xs bg-background border border-border rounded resize-none h-20"
										></textarea>
										<div class="flex gap-2 mt-3">
											<button
												class="feedback-submit bg-surreal-energy text-white px-3 py-1 rounded text-xs hover:bg-surreal-energy/80 transition-colors"
											>
												Submit
											</button>
											<button
												class="feedback-cancel text-text/60 px-3 py-1 rounded text-xs hover:text-text transition-colors"
											>
												Cancel
											</button>
										</div>
									</div>

									<!-- Negative Feedback Form -->
									<div
										class="feedback-form negative-feedback hidden"
									>
										<h4 class="text-sm font-semibold mb-3">
											What went wrong?
										</h4>
										<div class="flex flex-col gap-2 mb-3">
											<label
												class="flex items-center gap-2 text-xs"
											>
												<input
													type="radio"
													name="negative-feedback"
													value="hard-to-understand"
													class="w-3 h-3"
												/>
												<span>Hard to understand</span>
											</label>
											<label
												class="flex items-center gap-2 text-xs"
											>
												<input
													type="radio"
													name="negative-feedback"
													value="incorrect-info"
													class="w-3 h-3"
												/>
												<span
													>Incorrect information</span
												>
											</label>
											<label
												class="flex items-center gap-2 text-xs"
											>
												<input
													type="radio"
													name="negative-feedback"
													value="missing-info"
													class="w-3 h-3"
												/>
												<span
													>Missing the information</span
												>
											</label>
											<label
												class="flex items-center gap-2 text-xs"
											>
												<input
													type="radio"
													name="negative-feedback"
													value="other"
													class="w-3 h-3"
												/>
												<span>Other</span>
											</label>
										</div>
										<textarea
											placeholder="Tell us more about your experience"
											class="w-full p-2 text-xs bg-background border border-border rounded resize-none h-20"
										></textarea>
										<div class="flex gap-2 mt-3">
											<button
												class="feedback-submit bg-surreal-energy text-white px-3 py-1 rounded text-xs hover:bg-surreal-energy/80 transition-colors"
											>
												Submit
											</button>
											<button
												class="feedback-cancel text-text/60 px-3 py-1 rounded text-xs hover:text-text transition-colors"
											>
												Cancel
											</button>
										</div>
									</div>
								</div>

								<!-- Action Buttons -->
								<div class="flex gap-2 mt-2">
									<a
										href={`https://github.com/surrealdb/docs.surrealdb.com/edit/main/src/content/${collection}/${entry.id}`}
										class="flex items-center gap-1.5 px-2 py-1 rounded text-xs border border-border hover:border-surreal-energy hover:text-surreal-energy transition-colors"
									>
										<Icon
											name="fa6-solid:pencil"
											class="w-3 h-3"
										/>
										Edit
									</a>
									<a
										href="https://github.com/surrealdb/docs.surrealdb.com/issues/new"
										class="flex items-center gap-1.5 px-2 py-1 rounded text-xs border border-border hover:border-surreal-energy hover:text-surreal-energy transition-colors"
									>
										<Icon
											name="fa6-brands:github"
											class="w-3 h-3"
										/>
										Issue
									</a>
								</div>
							</div>
						</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Footer -->
			<Footer />
		</div>
	</div>
</BaseLayout>

<script>
	async function fetchLastEditedDate(filePath: string): Promise<[string, string]> {
		try {
			// Use GitHub API to get the last commit for the file
			const apiUrl = `https://api.github.com/repos/surrealdb/docs.surrealdb.com/commits?path=${encodeURIComponent(filePath)}&per_page=1`;
			const response = await fetch(apiUrl);

			if (!response.ok) {
				throw new Error(`GitHub API error: ${response.status}`);
			}

			const commits = (await response.json()) as any[];

			if (commits.length === 0) {
				return ["Unknown", ""];
			}

			const lastCommit = commits[0];
			const commitDate = new Date(lastCommit.commit.author.date);

			// Format the date like "Sep 6, 2024"
			const months = [
				"Jan",
				"Feb",
				"Mar",
				"Apr",
				"May",
				"Jun",
				"Jul",
				"Aug",
				"Sep",
				"Oct",
				"Nov",
				"Dec",
			];
			const month = months[commitDate.getMonth()];
			const day = commitDate.getDate();
			const year = commitDate.getFullYear();

			return [`${month} ${day}, ${year}`, commitDate.toISOString()];
		} catch (error) {
			console.error("Failed to fetch last edited date:", error);
			return ["Unknown", ""];
		}
	}

	document.querySelectorAll(".last-edited-date").forEach(async (element) => {
		const filePath = element.getAttribute("data-file-path");
		if (filePath) {
			const [formattedDate, isoDate] = await fetchLastEditedDate(filePath);
			element.textContent = formattedDate;
			element.setAttribute("data-last-edited-date", isoDate);
		}
	});

	// Add copy markdown functionality
	document.querySelectorAll('.copy-markdown-item').forEach((item) => {
		item.addEventListener("click", async () => {
			const url = item.getAttribute("data-url");
			if (!url) return;
			try {
				const response = await fetch(new URL(url));
				const text = await response.text();
				// Try modern clipboard API first
				try {
					await navigator.clipboard.writeText(text);
				} catch (err) {
					// Fallback for clipboard copy (deprecated, but still needed for mobile/old browsers)
					const textarea = document.createElement("textarea");
					textarea.value = text;
					textarea.style.position = "fixed";
					textarea.style.opacity = "0";
				document.body.appendChild(textarea);
				textarea.focus();
				textarea.select();
				// @ts-ignore - deprecated but needed for fallback support
				document.execCommand("copy");
				document.body.removeChild(textarea);
				}
			} catch (err) {
				console.error("Failed to copy markdown:", err);
				alert(
					"Failed to copy markdown. Please try manually selecting and copying the text.",
				);
			}
		});
	});

	// Mobile: Position action buttons below the H1 title
	function repositionMobileActions() {
		const buttons = document.querySelector('.page-header-actions');
		const h1 = document.querySelector('.flag-page-content > h1:first-of-type');
		const container = document.querySelector('.content-with-actions');
		
		if (!buttons || !h1 || !container) return;
		
		if (window.innerWidth <= 640) {
			// Move buttons after H1 on mobile
			if (h1.nextElementSibling !== buttons) {
				h1.after(buttons);
			}
		} else {
			// On desktop, ensure buttons are in their original position (first child of container)
			if (container.firstElementChild !== buttons) {
				container.prepend(buttons);
			}
		}
	}
	
	// Run on load and resize
	repositionMobileActions();
	window.addEventListener('resize', repositionMobileActions);

	// Page feedback functionality
	document.addEventListener("DOMContentLoaded", () => {
		const feedbackBtns = document.querySelectorAll(".feedback-btn");
		const feedbackForms = document.querySelector(".feedback-forms");
		const positiveForm = document.querySelector(".positive-feedback");
		const negativeForm = document.querySelector(".negative-feedback");
		const cancelBtns = document.querySelectorAll(".feedback-cancel");
		const submitBtns = document.querySelectorAll(".feedback-submit");

		// Handle feedback button clicks
		feedbackBtns.forEach((btn) => {
			btn.addEventListener("click", () => {
				const feedbackType = btn.getAttribute("data-feedback");

				// Hide all forms first
				positiveForm?.classList.add("hidden");
				negativeForm?.classList.add("hidden");
				feedbackForms?.classList.add("hidden");

				// Show the appropriate form
				if (feedbackType === "positive") {
					positiveForm?.classList.remove("hidden");
					feedbackForms?.classList.remove("hidden");
				} else if (feedbackType === "negative") {
					negativeForm?.classList.remove("hidden");
					feedbackForms?.classList.remove("hidden");
				}

				// Add visual feedback to buttons
				feedbackBtns.forEach((b) =>
					b.classList.remove(
						"border-surreal-energy",
						"bg-surreal-energy/10",
					),
				);
				btn.classList.add("border-surreal-energy", "bg-surreal-energy/10");
			});
		});

		// Handle cancel button clicks
		cancelBtns.forEach((btn) => {
			btn.addEventListener("click", () => {
				// Hide all forms
				feedbackForms?.classList.add("hidden");
				positiveForm?.classList.add("hidden");
				negativeForm?.classList.add("hidden");

				// Reset button states
				feedbackBtns.forEach((b) =>
					b.classList.remove(
						"border-surreal-energy",
						"bg-surreal-energy/10",
					),
				);

				// Clear form inputs
				document
					.querySelectorAll('input[type="radio"]')
					.forEach((radio) => {
						(radio as HTMLInputElement).checked = false;
					});
				document.querySelectorAll("textarea").forEach((textarea) => {
					(textarea as HTMLTextAreaElement).value = "";
				});
			});
		});

		// Handle submit button clicks
		submitBtns.forEach((btn) => {
			btn.addEventListener("click", async () => {
				const form = btn.closest(".feedback-form");
				if (!form) return;

				const isPositive = form.classList.contains("positive-feedback");
				const radioName = isPositive
					? "positive-feedback"
					: "negative-feedback";
				const selectedRadio = form.querySelector(
					`input[name="${radioName}"]:checked`,
				) as HTMLInputElement;
				const textarea = form.querySelector(
					"textarea",
				) as HTMLTextAreaElement;
				const element = document.querySelector(
					".last-edited-date",
				) as HTMLSpanElement;

				if (!selectedRadio) {
					alert("Please select an option before submitting.");
					return;
				}

				const feedbackData = {
					positive: isPositive,
					category: selectedRadio.value,
					comment: textarea.value,
					page: window.location.pathname,
					pageTitle: document.title,
					pageLastUpdated: element.dataset["lastEditedDate"],
					timestamp: new Date().toISOString(),
				};

				console.log(feedbackData);

				try {
					// TODO: Replace with actual Notion API endpoint
					// For now, just log the data and show success message
					const response = await fetch(
						"https://website-06bs2st681qcl18a0ee0iqak54.aws-euw1.surreal.cloud/api/surrealdb/documentation/feedback",
						{
							method: "POST",
							headers: {
								"Content-Type": "application/json",
								Accept: "application/json",
							},
							body: JSON.stringify(feedbackData),
						},
					);

					if (!response.ok) {
						throw new Error("Failed to submit feedback");
					}

					// Show success message
					btn.textContent = "Submitted!";
					btn.classList.add("bg-green-600");

					// Reset form after 2 seconds
					setTimeout(() => {
						feedbackForms?.classList.add("hidden");
						positiveForm?.classList.add("hidden");
						negativeForm?.classList.add("hidden");
						feedbackBtns.forEach((b) =>
							b.classList.remove(
								"border-surreal-energy",
								"bg-surreal-energy/10",
							),
						);
						btn.textContent = "Submit";
						btn.classList.remove("bg-green-600");

						// Clear form inputs
						document
							.querySelectorAll('input[type="radio"]')
							.forEach((radio) => {
								(radio as HTMLInputElement).checked = false;
							});
						document
							.querySelectorAll("textarea")
							.forEach((textarea) => {
								(textarea as HTMLTextAreaElement).value = "";
							});
					}, 2000);
				} catch (error) {
					console.error("Error submitting feedback:", error);
					alert("Failed to submit feedback. Please try again.");
				}
			});
		});
	});
</script>
