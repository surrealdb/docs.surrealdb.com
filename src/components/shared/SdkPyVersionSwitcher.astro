---
import { type SdkPyVersion, getVersionFromPath } from '@src/util/sdkPyVersion';

const MAJOR_RELEASES: SdkPyVersion[] = ['2.x', '1.x'];
const LATEST_VERSION: SdkPyVersion = 'latest';

const currentVersion = getVersionFromPath(Astro.url.pathname);

const getCurrentVersionDisplay = (): string => {
    if (currentVersion === 'latest') return 'Latest (2.x)';
    return currentVersion;
};
---

<div class="relative w-full" id="sdk-py-version-switcher-container">
    <div class="mb-2">
        <span class="text-xs uppercase tracking-[0.25em] text-text/60 font-semibold">
            Python SDK VERSION
        </span>
    </div>

    <button
        type="button"
        id="sdk-py-version-switcher-button"
        class="w-full flex items-center justify-between gap-2 px-3 py-2 text-sm border border-border rounded-md bg-background hover:border-surreal-energy/50 transition-colors focus:outline-none focus:ring-2 focus:ring-surreal-energy/20"
        aria-label="Select Python SDK version"
        aria-expanded="false"
    >
        <span class="font-semibold text-text">{getCurrentVersionDisplay()}</span>
        <svg
            class="w-4 h-4 flex-shrink-0 text-text/60 transition-transform"
            id="sdk-py-version-switcher-arrow"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            aria-hidden="true"
        >
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
    </button>

    <div
        id="sdk-py-version-switcher-menu"
        class="absolute top-full left-0 mt-1 w-full bg-background-secondary border border-border rounded-b-md shadow-xl z-[100] overflow-hidden hidden"
        role="menu"
    >
        <div class="py-1">
            <div class="px-4 py-1.5 text-xs uppercase tracking-wider text-text/50 font-semibold">
                LATEST
            </div>
            {(() => {
                const isSelected = currentVersion === LATEST_VERSION;
                return (
                    <button
                        type="button"
                        data-version={LATEST_VERSION}
                        data-path="/docs/sdk/python"
                        class="w-full flex items-center justify-between gap-2 px-4 py-2 text-sm hover:bg-bwr/10 transition-colors text-left group sdk-py-version-option"
                        class:list={{
                            'bg-surreal-energy/10': isSelected
                        }}
                    >
                        <div class="flex items-center gap-2 flex-1 min-w-0">
                            {isSelected ? (
                                <svg class="w-3.5 h-3.5 text-green-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20" aria-label="Selected version">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                </svg>
                            ) : (
                                <div class="w-3.5 h-3.5 flex-shrink-0" />
                            )}
                            <div class="flex-1 min-w-0">
                                <span class="font-semibold" class:list={{ 'text-surreal-energy': isSelected }}>Latest</span>
                            </div>
                        </div>
                    </button>
                );
            })()}
        </div>

        <div class="border-t border-border my-1" />

        <div class="py-1">
            <div class="px-4 py-1.5 text-xs uppercase tracking-wider text-text/50 font-semibold">
                SDK VERSIONS
            </div>
            {MAJOR_RELEASES.map((version) => {
                const isSelected = currentVersion === version;
                return (
                    <button
                        type="button"
                        data-version={version}
                        data-path={`/docs/${version}/sdk/python`}
                        class="w-full flex items-center justify-between gap-2 px-4 py-2 text-sm hover:bg-bwr/10 transition-colors text-left group sdk-py-version-option"
                        class:list={{
                            'bg-surreal-energy/10': isSelected
                        }}
                    >
                        <div class="flex items-center gap-2 flex-1 min-w-0">
                            {isSelected ? (
                                <svg class="w-3.5 h-3.5 text-green-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20" aria-label="Selected version">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                </svg>
                            ) : (
                                <div class="w-3.5 h-3.5 flex-shrink-0" />
                            )}
                            <span class="font-semibold" class:list={{ 'text-surreal-energy': isSelected }}>{version}</span>
                        </div>
                    </button>
                );
            })}
        </div>
    </div>

    <div
        id="sdk-py-version-switcher-backdrop"
        class="fixed inset-0 z-[90] hidden"
        role="button"
        tabindex={-1}
        aria-label="Close version selector"
    />
</div>

<script>
    const STORAGE_KEY = 'sdkPyPreferredVersion';

    const container = document.getElementById('sdk-py-version-switcher-container');
    const button = document.getElementById('sdk-py-version-switcher-button');
    const menu = document.getElementById('sdk-py-version-switcher-menu');
    const arrow = document.getElementById('sdk-py-version-switcher-arrow');
    const backdrop = document.getElementById('sdk-py-version-switcher-backdrop');

    if (!container || !button || !menu || !arrow || !backdrop) {
        console.error('[SdkPyVersionSwitcher] Missing required elements');
    } else {
        let isOpen = false;

        const toggleMenu = (open: boolean) => {
            isOpen = open;
            if (open) {
                menu.classList.remove('hidden');
                backdrop.classList.remove('hidden');
                arrow.classList.add('rotate-180');
                button.setAttribute('aria-expanded', 'true');
            } else {
                menu.classList.add('hidden');
                backdrop.classList.add('hidden');
                arrow.classList.remove('rotate-180');
                button.setAttribute('aria-expanded', 'false');
            }
        };

        button.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            toggleMenu(!isOpen);
        });

        const versionOptions = container.querySelectorAll('.sdk-py-version-option');
        versionOptions.forEach((option) => {
            option.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();

                const version = (option as HTMLElement).dataset.version;
                const newPath = (option as HTMLElement).dataset.path;

                if (!version || !newPath) {
                    console.error('[SdkPyVersionSwitcher] Missing version or path data');
                    return;
                }

                localStorage.setItem(STORAGE_KEY, version);
                window.location.href = newPath;
            });
        });

        backdrop.addEventListener('click', () => {
            toggleMenu(false);
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && isOpen) {
                toggleMenu(false);
            }
        });
    }
</script>
