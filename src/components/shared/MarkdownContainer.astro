---
interface Props {
    class?: string;
}

const { class: className } = Astro.props;
---

<style>
    .flag-markdown {
        & :global(h1), & :global(h2), & :global(h3), & :global(h4), & :global(h5), & :global(h6) {
            @apply items-center mb-4 mt-10;
            scroll-margin-top: 2rem;
        }

        & :global(h1) {
            @apply text-3xl sm:text-[2.5rem] font-medium sm:leading-[3rem];
        }
        & :global(h2) {
            @apply text-3xl sm:text-4xl font-medium;
        }
        & :global(h3) {
            @apply text-2xl sm:text-3xl font-medium;
        }
        & :global(h4) {
            @apply text-xl sm:text-2xl font-medium;
        }
        & :global(h5) {
            @apply text-lg sm:text-xl font-medium;
        }
        & :global(h6) {
            @apply sm:text-lg font-medium;
        }

        & :global(.anchor-link) {
            @apply inline-flex ml-3 text-text/50 flex items-center mb-0;

            &:hover {
                @apply text-surreal-pink;
            }
        }

        & :global(p) {
            @apply mb-4 dark:text-faint;

            &:last-child {
                @apply mb-0;
            }
        }

        & :global(strong), & :global(b) {
            @apply font-bold text-text;
        }
        & :global(a) {
            @apply text-hover transition-colors duration-300 hover:underline;
            & :global(code) {
                @apply !text-inherit;
            }
            &:last-child {
                @apply mb-0;
            }
        }
        & :global(img) {
            @apply mb-4 w-full;
        }
        & :global(pre) {
            @apply mb-8 rounded-lg text-sm bg-border/45 border-[1px] border-border relative leading-[1.4rem];

            & :global(.code-title) {
                @apply !block bg-background px-4 py-3 rounded-t-lg font-mono border-b border-border text-wrap;
            }

            & :global(.code-container), &:global(:not(:has(.code-title)):not(:has(.code-container))) {
                @apply !block p-4 overflow-x-auto;
            }

            & :global(.code-container), & > :global(code) {
                & > :global(div) {
                    @apply inline-block w-full;
                }
            }

            & :global(.code-copy) {
                @apply bg-background w-8 h-8 absolute top-0 right-0 m-1 flex items-center justify-center rounded-md cursor-pointer border-[1px] border-border opacity-0 transition-all duration-150 active:scale-95;
            }

            &:has(.code-title) :global(.code-copy) {
                @apply mt-[3.15rem];
            }

            &:hover :global(.code-copy) {
                @apply opacity-100;
            }

            & :global(.tok-keyword) { color: #ff009e; }
            & :global(.tok-operator) { color: #ff00ff; }
            & :global(.tok-number) { color: #00dbff; }
            & :global(.tok-string) { color: #00ff6e; }
            & :global(.tok-comment) { color: #737e98; }
            & :global(.tok-propertyName) { color: #e06c75; }
            & :global(.tok-variableName) { color: #ffde00; }
            & :global(.tok-punctuation) { color: #ffffff; }
            & :global(.tok-function) { color: #ff9b67; }
            & :global(.tok-null) { color: #9d2fff; }
            & :global(.tok-bool) { color: #9d2fff; }
            & :global(.tok-name) { color: #ffffff; }
            & :global(.tok-typeName) { color: #ffde00; }
            & :global(.tok-literal) { color: #9d2fff; }
            & :global(.tok-className) { color: #0084ff; }

            & :global(.language-surql),
            & :global(.language-surrealql) {
                & :global(.tok-propertyName) { color: #ffffff; }
            }

            @media (prefers-color-scheme: light) {
                & :global(.tok-keyword) { color: #d80086; }
                & :global(.tok-operator) { color: #bf00bf; }
                & :global(.tok-number) { color: #00a4bf; }
                & :global(.tok-string) { color: #00bf52; }
                & :global(.tok-comment) { color: #737e98; }
                & :global(.tok-propertyName) { color: #e06c75; }
                & :global(.tok-variableName) { color: #bfa600; }
                & :global(.tok-punctuation) { color: #000000; }
                & :global(.tok-function) { color: #ff600d; }
                & :global(.tok-null) { color: #bf00bf; }
                & :global(.tok-bool) { color: #bf00bf; }
                & :global(.tok-name) { color: #000000; }
                & :global(.tok-typeName) { color: #bfa600; }
                & :global(.tok-literal) { color: #bf00bf; }
                & :global(.tok-className) { color: #0062bf; }

                & :global(.language-surql),
                & :global(.language-surrealql) {
                    & :global(.tok-propertyName) { color: #000000; }
                }
            }
        }
        & :global(:not(pre)) > :global(code) {
            @apply rounded px-1.5 text-text/80 inline-block max-w-full bg-border/50 border border-border;

            & :global(.code-container) {
                @apply overflow-x-auto;
            }

            @media (max-width: 640px) {
                @apply break-words whitespace-pre-wrap;
            }
        }

        & :global(ul) {
            @apply mb-8 ml-8 list-disc dark:text-faint;
        }
        & :global(ol) {
            @apply mb-8 ml-8 list-decimal dark:text-faint;
        }

        & :global(li) {
            @apply mt-4;

            &:last-child {
                @apply mb-4;
            }
        }

        & :global(iframe) {
            @apply mb-8;
        }

        & :global(blockquote) {
            @apply mb-8 rounded-lg border-l-4 border-l-hover bg-code border border-border p-5;

            & :global(code) {
                @apply bg-bwr/5 py-0.5;
            }

            &:global(.kind-note) {
                @apply border-l-quote-note;

                & :global(.kind-heading) {
                    @apply text-quote-note;
                }
            }

            &:global(.kind-important) {
                @apply border-l-quote-important;

                & :global(.kind-heading) {
                    @apply text-quote-important;
                }
            }

            &:global(.kind-warning) {
                @apply border-l-quote-warning;

                & :global(.kind-heading) {
                    @apply text-quote-warning;
                }
            }

            &:global(.kind-caution) {
                @apply border-l-quote-caution;

                & :global(.kind-heading) {
                    @apply text-quote-caution;
                }
            }

            & :global(.kind-heading) {
                @apply flex items-center gap-1.5 text-lg font-semibold mb-2;
                & :global(svg) {
                    @apply w-5 h-5;
                }
            }

            & :global(> *) {
                @apply mb-0;
            }
        }

        & :global(table) {
            @apply w-full mb-8;
            & :global(th) {
                @apply text-left font-bold;
            }
            & :global(td, th) {
                @apply px-4 py-3;

                & :global(p), & :global(a) {
                    @apply mb-0;
                }
            }
            & :global(tr:not(:first-child)) {
                @apply border-t dark:border-t-2 border-t-border;
            }
            & :global(thead tr:only-child) {
                @apply border-b dark:border-b-2 border-b-border;
            }

            @media not all and screen(md) {
                & :global(thead) {
                    @apply hidden;
                }

                & :global(tr) {
                    @apply block mb-2 !border border-border;
                }

                & :global(th) {
                    @apply p-3;
                }

                & :global(td) {
                    @apply block text-right p-3 bg-code min-h-16;

                    &:before {
                        content: attr(data-label);
                        @apply float-left font-bold text-text/80 mr-4 uppercase;
                    }

                    &:not(:first-child) {
                        @apply border-t border-border;
                    }
                }
            }
        }

        & :global(.flag-image-title) {
            @apply w-10 sm:w-[3.25rem] rounded-none mr-4 float-left;

            & :global(img) {
                @apply rounded-none;
            }

            & :global(+ *) {
                @apply sm:!h-12 float-left;

                & :global(+ *) {
                    @apply inline-block;
                }
            }
        }
    }
</style>

<markdown-container class:list={['flag-markdown block', className]}>
    <slot />
</markdown-container>

<script>
    class MarkdownContainer extends HTMLElement {
        connectedCallback() {
            const targets = this.querySelectorAll('.code-copy');
            for (const target of targets) {
                let code = target.parentElement?.querySelector('code');
                if (!code) {
                    target.remove();
                    continue;
                }

                const inner = code.querySelector('.code-container');
                if (inner) {
                    code = inner as HTMLElement;
                }

                target.addEventListener('click', () => {
                    navigator.clipboard.writeText(code.innerText);
                });
            }
        }
    }

    customElements.define('markdown-container', MarkdownContainer);
</script>
