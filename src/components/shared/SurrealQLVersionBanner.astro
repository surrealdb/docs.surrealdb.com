---
import fs from 'node:fs';
import path from 'node:path';
import {
    type SurrealQLVersion,
    compareVersions,
    getVersionFromPath,
    toVersionedPath,
} from '@src/util/surrealqlVersion';

interface Props {
    currentPath: string;
    contentPath?: string; // Path to the markdown file
}

const { currentPath, contentPath } = Astro.props;
const currentVersion = getVersionFromPath(currentPath);

/**
 * Check if the page content has any 3.0+ features
 */
function hasV3Content(contentPath?: string): boolean {
    if (!contentPath) return false;

    try {
        const fullPath = path.join(process.cwd(), 'src/content', contentPath);
        const content = fs.readFileSync(fullPath, 'utf-8');

        // Check for various patterns that indicate 3.0+ content:
        // 1. "Available since: v3.0" or similar
        // 2. <Since v="v3.0" /> or similar
        // 3. <VersionGate since="v3.0"> or similar
        // 4. Any version string >= 3.0.0

        const v3Patterns = [
            /Available since:\s*v3\./i,
            /<Since\s+v=["']v3\./i,
            /<VersionGate\s+since=["']v3\./i,
            /since=["']v3\./i,
        ];

        // Check for explicit 3.0+ version markers
        for (const pattern of v3Patterns) {
            if (pattern.test(content)) {
                return true;
            }
        }

        // Check for version strings like v3.0.0, v3.1.0, etc.
        const versionMatches = content.match(/v(\d+)\.(\d+)(?:\.(\d+))?/g);
        if (versionMatches) {
            for (const versionStr of versionMatches) {
                // Check if it's 3.0 or higher
                if (compareVersions(versionStr, 'v3.0.0') >= 0) {
                    // Make sure it's in a context that suggests it's a feature marker
                    // (not just a random version number in text)
                    const context = content.substring(
                        Math.max(0, content.indexOf(versionStr) - 50),
                        Math.min(
                            content.length,
                            content.indexOf(versionStr) + 50
                        )
                    );
                    if (
                        /Available since|since=|VersionGate|Since\s+v=/i.test(
                            context
                        )
                    ) {
                        return true;
                    }
                }
            }
        }

        return false;
    } catch (e) {
        // If we can't read the file, default to not showing the banner
        console.debug(
            '[SurrealQLVersionBanner] Could not read content file:',
            e
        );
        return false;
    }
}

// Only show banner on 2.x pages that actually have 3.0+ content
const hasV3 = hasV3Content(contentPath);
const showBanner = currentVersion === '2.x' && hasV3;
// Link to 3.x version of the same page
const v3Path = toVersionedPath(currentPath, '3.x');
---

{showBanner && (
    <div class="mb-4 p-3 bg-surreal-pink/10 border border-surreal-pink/30 rounded-lg text-sm">
        <div class="flex items-center justify-between gap-2 flex-wrap">
            <span class="text-text/80">
                There are updates in 3.0 for this topic
            </span>
            <a
                href={v3Path}
                class="text-surreal-pink hover:underline font-medium whitespace-nowrap"
                data-version-override="3.x"
            >
                View v3.x â†’
            </a>
        </div>
    </div>
)}

