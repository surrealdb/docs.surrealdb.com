---
import {
    type SurrealQLVersion,
    compareVersions,
    getMinimumVersion,
    getVersionFromPath,
    versionMatches,
} from '@src/util/surrealqlVersion';

type Version = `v${number}.${number | 'x'}${string}`;

interface Props {
    v: Version;
    prefix?: string | false;
    // Optional: specify if this is for SurrealQL docs (auto-detected from URL)
    isSurrealQL?: boolean;
}

const { v, prefix, isSurrealQL } = Astro.props;

// Regular expression to validate the version format, supporting both x and pre-release versions
const versionRegex = /^v?\d+\.(x|\d+)(\.\d+)?(-[a-zA-Z]+([.-]\d+)?)?$/;

// Check if the passed version matches the expected format
if (!versionRegex.test(v)) {
    throw new Error(`Error: Version ${v} is not recognized.`);
}

// Auto-detect if we're on a SurrealQL page
const pathname = Astro.url.pathname;
const isSurrealQLPage =
    isSurrealQL ??
    (pathname.startsWith('/docs/surrealql') ||
        pathname.startsWith('/docs/2.x/surrealql') ||
        pathname.startsWith('/docs/3.x/surrealql'));

let currentVersion: SurrealQLVersion | null = null;
let isAvailableInVersion = true;
let newerVersionAvailable: SurrealQLVersion | null = null;

if (isSurrealQLPage) {
    currentVersion = getVersionFromPath(pathname);

    // Check if this feature is available in the current version
    isAvailableInVersion = versionMatches(v, currentVersion);

    // Check if a newer version exists
    const minVersion = getMinimumVersion(v);
    if (minVersion && currentVersion !== 'latest') {
        if (minVersion === '3.x' && currentVersion === '2.x') {
            newerVersionAvailable = '3.x';
        }
    }
}
---

<style>
    p {
        @apply flex w-fit h-6 items-center whitespace-nowrap rounded border px-2 font-mono text-xs uppercase leading-[0] border-label-purple !text-label-purple;
    }

    @media (prefers-color-scheme: light) {
        p {
            @apply bg-label-purple !text-white
        }
    }
    
    .since-unavailable {
        @apply border-red-500 !text-red-500;
    }
    
    @media (prefers-color-scheme: light) {
        .since-unavailable {
            @apply bg-red-500 !text-white;
        }
    }
    
    .since-link {
        @apply ml-2 text-xs underline hover:text-surreal-pink;
    }
</style>

{isSurrealQLPage && !isAvailableInVersion && currentVersion ? (
    <div class="flex items-center gap-2 flex-wrap">
        <p class="since-unavailable">
            Not available in this version
            {(() => {
            const minVersion = getMinimumVersion(v);
            if (minVersion) {
                // If we're on 2.x and the feature requires 3.x, link to 3.x version
                if (currentVersion === '2.x' && minVersion === '3.x') {
                    // Get the relative path and build 3.x path
                    const relativePath = pathname.replace(/^\/docs\/(?:2\.x|3\.x)\/surrealql/, '').replace(/^\/docs\/surrealql/, '') || '/';
                    const v3Path = `/docs/3.x/surrealql${relativePath === '/' ? '' : relativePath}`;
                    return (
                        <a href={v3Path} class="since-link" data-version-override="3.x">
                            See v3.x version
                        </a>
                    );
                }
                // Fallback to latest for other cases
                const relativePath = pathname.replace(/^\/docs\/(?:2\.x|3\.x)\/surrealql/, '').replace(/^\/docs\/surrealql/, '') || '/';
                const latestPath = `/docs/surrealql${relativePath === '/' ? '' : relativePath}`;
                return (
                    <a href={latestPath} class="since-link" data-version-override="latest">
                        See Latest version
                    </a>
                );
            }
            return null;
        })()}
        </p>
        <br/>
       
    </div>
) : isSurrealQLPage && newerVersionAvailable ? (
    <div class="flex items-center gap-2 flex-wrap">
        <p>
            {prefix !== false && (prefix ?? "Available since: ")}{v}
        </p>
        {(() => {
            const versionedPath = pathname.replace(/^\/docs\/surrealql/, `/docs/${newerVersionAvailable}/surrealql`)
                .replace(/^\/docs\/2\.x\/surrealql/, `/docs/${newerVersionAvailable}/surrealql`);
            return (
                <a href={versionedPath} class="since-link">
                        See v{newerVersionAvailable === '3.x' ? '3.x' : newerVersionAvailable} version
                </a>
            );
        })()}
    </div>
) : (
    <p>
        {prefix !== false && (prefix ?? "Available since: ")}{v}
    </p>
)}
