---
import { type CollectionEntry, getCollection } from 'astro:content';
import RenderDoc from '@src/components/RenderDoc.astro';
import { getMeta } from '@src/util/doc';
import { SDK_JS_VERSIONS, type SdkJsVersion } from '@src/util/sdkJsVersion';
import type { GetStaticPaths } from 'astro';

export const getStaticPaths = (async () => {
    const paths: Array<{ params: { version: string; slug: string } }> = [];

    // Generate paths for each version
    for (const version of SDK_JS_VERSIONS) {
        if (version === 'latest') continue; // Latest is handled by the main route

        // Determine collection for this version
        const collectionName =
            version === '1.x' ? 'doc-sdk-javascript-1x' : 'doc-sdk-javascript';
        const collection = await getCollection(collectionName);

        for (const { slug } of collection) {
            if (slug === 'index') continue; // Index pages handled separately

            paths.push({
                params: {
                    version,
                    slug,
                },
            });
        }
    }

    return paths;
}) satisfies GetStaticPaths;

const { version, slug: slugParam } = Astro.params;

// Validate version
if (!version || !SDK_JS_VERSIONS.includes(version as SdkJsVersion)) {
    return Astro.redirect('/docs/sdk/javascript', 301);
}

// Handle slug array from catch-all route
const slug = (
    Array.isArray(slugParam) ? slugParam.join('/') : slugParam || ''
) as CollectionEntry<'doc-sdk-javascript'>['slug'];

// Determine collection based on version
const docName = version === '1.x' ? 'sdk-javascript-1x' : 'sdk-javascript';
const collectionName = `doc-${docName}` as
    | 'doc-sdk-javascript'
    | 'doc-sdk-javascript-1x';

// Validate that the slug exists in the collection
const collection = await getCollection(collectionName);
const entryExists = collection.some((entry) => entry.slug === slug);

if (!entryExists) {
    return Astro.redirect('/docs/sdk/javascript', 301);
}

const meta = await getMeta(collectionName, slug);
const noPageHeadings = meta.no_page_headings;
---

<RenderDoc doc={docName as any} slug={slug as any} noPageHeadings={noPageHeadings} />
