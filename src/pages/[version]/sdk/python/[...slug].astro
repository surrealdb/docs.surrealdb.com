---
import { type CollectionEntry, getCollection } from 'astro:content';
import RenderDoc from '@src/components/RenderDoc.astro';
import { getMeta } from '@src/util/doc';
import { SDK_PY_VERSIONS, type SdkPyVersion } from '@src/util/sdkPyVersion';
import type { GetStaticPaths } from 'astro';

export const getStaticPaths = (async () => {
    const paths: Array<{ params: { version: string; slug: string } }> = [];

    for (const version of SDK_PY_VERSIONS) {
        if (version === 'latest') continue;

        const collectionName =
            version === '1.x' ? 'doc-sdk-python-1x' : 'doc-sdk-python';
        const collection = await getCollection(collectionName);

        for (const { slug } of collection) {
            if (slug === 'index') continue;

            paths.push({
                params: {
                    version,
                    slug,
                },
            });
        }
    }

    return paths;
}) satisfies GetStaticPaths;

const { version, slug: slugParam } = Astro.params;

if (!version || !SDK_PY_VERSIONS.includes(version as SdkPyVersion)) {
    return Astro.redirect('/docs/sdk/python', 301);
}

const slug = (
    Array.isArray(slugParam) ? slugParam.join('/') : slugParam || ''
) as CollectionEntry<'doc-sdk-python'>['slug'];

const docName = version === '1.x' ? 'sdk-python-1x' : 'sdk-python';
const collectionName = `doc-${docName}` as
    | 'doc-sdk-python'
    | 'doc-sdk-python-1x';

const collection = await getCollection(collectionName);
const entryExists = collection.some((entry) => entry.slug === slug);

if (!entryExists) {
    return Astro.redirect('/docs/sdk/python', 301);
}

const meta = await getMeta(collectionName, slug);
const noPageHeadings = meta.no_page_headings;
---

<RenderDoc doc={docName as any} slug={slug as any} noPageHeadings={noPageHeadings} />
