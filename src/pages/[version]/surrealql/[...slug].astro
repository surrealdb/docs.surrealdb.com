---
import { type CollectionEntry, getCollection } from 'astro:content';
import RenderDoc from '@src/components/RenderDoc.astro';
import { getMeta } from '@src/util/doc';
import {
    SURREALQL_VERSIONS,
    type SurrealQLVersion,
} from '@src/util/surrealqlVersion';
import type { GetStaticPaths } from 'astro';

export const getStaticPaths = (async () => {
    const collection = await getCollection('doc-surrealql');
    const paths: Array<{ params: { version: string; slug: string } }> = [];

    // Generate paths for each version
    for (const version of SURREALQL_VERSIONS) {
        if (version === 'latest') continue; // Latest is handled by the main route

        for (const { slug } of collection) {
            if (slug === 'index') continue; // Index pages handled separately

            // Only generate paths for valid slugs
            paths.push({
                params: {
                    version,
                    slug,
                },
            });
        }
    }

    return paths;
}) satisfies GetStaticPaths;

const { version, slug: slugParam } = Astro.params;

// Validate version
if (!version || !SURREALQL_VERSIONS.includes(version as SurrealQLVersion)) {
    return Astro.redirect('/docs/surrealql', 301);
}

// Handle slug array from catch-all route
const slug = (
    Array.isArray(slugParam) ? slugParam.join('/') : slugParam || ''
) as CollectionEntry<'doc-surrealql'>['slug'];

// Validate that the slug exists in the collection
const collection = await getCollection('doc-surrealql');
const entryExists = collection.some(
    (entry: CollectionEntry<'doc-surrealql'>) => entry.slug === slug
);

if (!entryExists) {
    return Astro.redirect('/docs/surrealql', 301);
}

const meta = await getMeta('doc-surrealql', slug);
const noPageHeadings = meta.no_page_headings;
const noSidebar = meta.no_sidebar;
---

<RenderDoc doc="surrealql" slug={slug} noPageHeadings={noPageHeadings} noSidebar={noSidebar} />

