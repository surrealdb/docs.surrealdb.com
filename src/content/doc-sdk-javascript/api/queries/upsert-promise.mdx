---
sidebar_position: 6
sidebar_label: UpsertPromise
title: JavaScript | SDK | API Reference | UpsertPromise
description: UpsertPromise provides chainable methods for configuring UPSERT operations (insert or replace).
---

import Label from "@components/shared/Label.astro";

# `UpsertPromise<T, I, J>` {#upsertpromise}

The `UpsertPromise` class provides a chainable interface for configuring UPSERT operations (insert if not exists, replace if exists). It extends `Promise`, allowing you to `await` it directly or chain configuration methods.

> [!WARNING]
> UPSERT replaces the entire record if it exists. Use [`update().merge()`](/docs/sdk/javascript/api/queries/update-promise#merge) for partial updates.

**Returned by:** [`SurrealQueryable.upsert()`](/docs/sdk/javascript/api/core/surreal-queryable#upsert)

**Source:** [query/upsert.ts](https://github.com/surrealdb/surrealdb.js/blob/main/packages/sdk/src/query/upsert.ts)

## Type Parameters

- `T` - The result type
- `I` - The input type for record data
- `J` - Boolean indicating if result is JSON (default: `false`)

## Configuration Methods

### `.content()` {#content}

Set the complete content for the record (insert or replace).

```ts title="Method Syntax"
upsertPromise.content(data)
```

#### Parameters
<table>
    <thead>
        <tr>
            <th>Parameter</th>
            <th>Type</th>
            <th>Description</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><code>data</code> <Label label="required" /></td>
            <td><code>Values&lt;I&gt;</code></td>
            <td>Complete record data (excluding id field).</td>
        </tr>
    </tbody>
</table>

#### Returns
`UpsertPromise<T, I, J>` - Chainable promise

#### Example

```ts
const user = await db.upsert(new RecordId('users', 'john'))
    .content({
        name: 'John Doe',
        email: 'john@example.com',
        age: 30
    });
// Inserts if not exists, replaces entirely if exists
```

---

### `.merge()` {#merge}

Merge data into the record (insert if not exists, merge if exists).

```ts title="Method Syntax"
upsertPromise.merge(data)
```

#### Parameters
<table>
    <thead>
        <tr>
            <th>Parameter</th>
            <th>Type</th>
            <th>Description</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><code>data</code> <Label label="required" /></td>
            <td><code>Partial&lt;Values&lt;I&gt;&gt;</code></td>
            <td>Partial data to merge.</td>
        </tr>
    </tbody>
</table>

#### Returns
`UpsertPromise<T, I, J>` - Chainable promise

#### Example

```ts
const user = await db.upsert(new RecordId('users', 'john'))
    .merge({
        name: 'John Doe',
        last_login: DateTime.now()
    });
// If exists: merges fields; if not: creates with these fields
```

---

### `.replace()` {#replace}

Replace specific fields.

```ts title="Method Syntax"
upsertPromise.replace(data)
```

#### Parameters
<table>
    <thead>
        <tr>
            <th>Parameter</th>
            <th>Type</th>
            <th>Description</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><code>data</code> <Label label="required" /></td>
            <td><code>Values&lt;I&gt;</code></td>
            <td>Fields to replace.</td>
        </tr>
    </tbody>
</table>

#### Returns
`UpsertPromise<T, I, J>` - Chainable promise

---

### `.patch()` {#patch}

Apply JSON Patch operations.

```ts title="Method Syntax"
upsertPromise.patch(operations)
```

#### Parameters
<table>
    <thead>
        <tr>
            <th>Parameter</th>
            <th>Type</th>
            <th>Description</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><code>operations</code> <Label label="required" /></td>
            <td><code>PatchOperation[]</code></td>
            <td>JSON Patch operations.</td>
        </tr>
    </tbody>
</table>

#### Returns
`UpsertPromise<T, I, J>` - Chainable promise

---

### `.where()` {#where}

Add a WHERE clause for conditional upsert.

```ts title="Method Syntax"
upsertPromise.where(condition)
```

#### Parameters
<table>
    <thead>
        <tr>
            <th>Parameter</th>
            <th>Type</th>
            <th>Description</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><code>condition</code> <Label label="required" /></td>
            <td><code>ExprLike</code></td>
            <td>The condition expression (string or <a href="/docs/sdk/javascript/api/utilities/expr">Expression</a> object).</td>
        </tr>
    </tbody>
</table>

#### Returns
`UpsertPromise<T, I, J>` - Chainable promise

---

### `.output()` {#output}

Specify what to return.

```ts title="Method Syntax"
upsertPromise.output(fields)
```

#### Parameters
<table>
    <thead>
        <tr>
            <th>Parameter</th>
            <th>Type</th>
            <th>Description</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><code>fields</code> <Label label="required" /></td>
            <td><code>Output</code></td>
            <td><code>"NONE"</code>, <code>"BEFORE"</code>, <code>"AFTER"</code>, <code>"DIFF"</code>, or field list.</td>
        </tr>
    </tbody>
</table>

#### Returns
`UpsertPromise<T, I, J>` - Chainable promise

---

### `.timeout()` {#timeout}

Set operation timeout.

```ts title="Method Syntax"
upsertPromise.timeout(duration)
```

#### Returns
`UpsertPromise<T, I, J>` - Chainable promise

---

### `.version()`, `.json()`, `.stream()`

See other query builders for these common methods.

## Complete Examples

### Basic Upsert

```ts
import { Surreal, RecordId } from 'surrealdb';

const db = new Surreal();
await db.connect('ws://localhost:8000');

// Upsert: insert if not exists, replace if exists
const user = await db.upsert(new RecordId('users', 'john'))
    .content({
        name: 'John Doe',
        email: 'john@example.com',
        role: 'user'
    });
```

### Upsert with Merge

```ts
// Safer: merge instead of replace
const user = await db.upsert(new RecordId('users', 'john'))
    .merge({
        last_login: DateTime.now(),
        login_count: 1
    });
// If user exists: only updates these fields
// If not: creates user with these fields
```

### Bulk Upsert

```ts
const users = await db.upsert(new Table('users'))
    .content(userDataArray);
```

### Track Changes

```ts
const result = await db.upsert(new RecordId('users', 'john'))
    .content(userData)
    .output('DIFF');

if (result) {
    console.log('Created or updated:', result);
}
```

### Conditional Upsert

```ts
const user = await db.upsert(new RecordId('users', 'john'))
    .merge({ status: 'active' })
    .where('verified = true');
```

## UPSERT vs CREATE vs UPDATE

```ts
// CREATE: Fails if record exists
try {
    await db.create(recordId).content(data);
} catch (error) {
    // Error if exists
}

// UPDATE: Fails if record doesn't exist
try {
    await db.update(recordId).merge(data);
} catch (error) {
    // Error if not found
}

// UPSERT: Works in both cases
await db.upsert(recordId).content(data);
// Always succeeds
```

## Use Cases

### Session Management

```ts
// Update session or create new one
async function updateSession(sessionId: string, data: SessionData) {
    return db.upsert(new RecordId('sessions', sessionId))
        .merge({
            ...data,
            last_activity: DateTime.now()
        });
}
```

### Cache Pattern

```ts
// Write-through cache
async function cacheSet(key: string, value: unknown) {
    return db.upsert(new RecordId('cache', key))
        .content({
            value,
            expires_at: DateTime.now().plus(Duration.parse('1h'))
        });
}
```

### Counter Pattern

```ts
// Increment counter or initialize
const counter = await db.upsert(new RecordId('counters', 'page_views'))
    .merge({
        count: 1,
        last_increment: DateTime.now()
    });
```

## Chaining Pattern

```ts
const result = await db.upsert(new RecordId('users', 'john'))
    .content(userData)
    .output('AFTER')
    .timeout(Duration.parse('5s'));
```

## See Also

- [SurrealQueryable.upsert()](/docs/sdk/javascript/api/core/surreal-queryable#upsert) - Method that returns UpsertPromise
- [CreatePromise](/docs/sdk/javascript/api/queries/create-promise) - Create only
- [UpdatePromise](/docs/sdk/javascript/api/queries/update-promise) - Update only
- [Query Overview](/docs/sdk/javascript/api/queries/) - All query builder classes
